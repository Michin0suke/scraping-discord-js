# Scraping Discord Bot

## 概要

任意のサイトを定期的にスクレイピングし、追加された記事を通知するボットです。

## 使い方

### Botを有効化させる

VPSなどにこのリポジトリをクローンします。
`config_sample.ts`と`ormconfig_sample.json`のファイル名から`_sample`を取り除き、ファイルの中身を適切に変更してください。
適宜、npmの`forever`などでプログラムを常駐させてください。
あとは、使いたいチャンネルにBotを招待すれば、準備は調います。


### Discordチャンネルに設定する

1. ボットにメンションした上で、`ヘルプを表示する`と送信してください。コマンド一覧が表示されます。
2. 次に、`このチャンネルを登録する`コマンドを実行して、ボットにチャンネルを登録します。
3. `example.comから最新の記事を取得するタスクを追加する`の様にコマンドを実行してタスクを追加します。
4. `ステータスを表示する`コマンドを実行して、追加したタスクのIDを確認してください。
5. ```
   IDが1のタスクに以下のプログラムを追加する
   `` `js
   ここにプログラムを書く
   `` `
   ```
   の様にコマンドを実行して、タスクにプログラムを追加します。
   **※プログラムについてはREADME下部をご参照ください。**
6. `IDが1のタスクを起動`の様にコマンドを実行し、タスクを起動します。


### コマンド一覧

```
このチャンネルを登録　　　　　　　　　　　　　　現在のチャンネルを登録します。
このチャンネルの登録を解除　　　　　　　　　　　チャンネルとの連携を解除します。
ステータスを表示　　　　　　　　　　　　　　　　現在のサーバに登録されているチャンネルとタスクを表示します。
このチャンネルのタスク一覧を表示　　　　　　　　現在のチャンネルに登録されているタスクを表示します。
〜するタスクを追加　　　　　　　　　　　　　　　指定した〜するためのタスクを登録できます。
ＩＤが１のタスクに以下のプログラムを追加　　　　タスクにプログラムを追加できます。
ＩＤが１のタスクのプログラムを削除　　　　　　　タスクのプログラムを削除できます。
ＩＤが１のタスクを削除　　　　　　　　　　　　　タスクを削除できます。
ＩＤが１のタスクを起動　　　　　　　　　　　　　ステータスをｒｕｎｎｉｎｇにします。
ＩＤが１のタスクを停止　　　　　　　　　　　　　ステータスをｓｔｏｐｐｅｄにします。
ＩＤが１のタスクを一度だけ実行　　　　　　　　　タスクのプログラムを仮実行して結果を表示します。
ＩＤが１のタスクのインターバルを１５分に変更　　タスクが実行されるインターバルを変更します。
ＩＤが１のタスクのログを表示　　　　　　　　　　タスクのログを表示します。
ＩＤが１のタスクのプログラムを表示　　　　　　　タスクのプログラムを表示
ＩＤが１のタスクの詳細を表示　　　　　　　　　　タスクの詳細を表示します。
サンプルプログラムを表示　　　　　　　　　　　　プログラムの例を表示します。
ヘルプを表示　　　　　　　　　　　　　　　　　　このヘルプを表示
```

### 仕組み
このBotは、指定されたプログラムを指定された間隔で実行します。
プログラムによって返された配列の`url`とすでにデータベースに保存されている`url`の差分を取り、新しいURLが検知されたら通知ののちにデータベースに保存します。

### プログラムについて
プログラム内では、`fetch`([node-fetch](https://www.npmjs.com/package/node-fetch))、`cheerio`([cheeriojs](https://github.com/cheeriojs/cheerio))が使用できます。非同期関数内なので、`await`構文も使用できます。
最終的には、`return`で以下のようなフォーマットの配列を返却する必要があります。

```js
return ([
  {
    title: '記事タイトル1',
    url: 'https://example.com/article/1',
  },
  {
    title: '記事タイトル2',
    url: 'https://example.com/article/2',
  }
])
```

### JavaScriptの実行テスト
ボットにメンションした上で、単にJavaScriptのブロックを送信すると、returnしたオブジェクトをJSON形式で返します。
```
@Bot
`` `js
return 'hello world'
`` `
```

### サンプルプログラム
```js
const html = await fetch('https://example.com/').then(res => res.text())
const $ = cheerio.load(html, null, false)
const arr = []
$('.entry-title a').each((index, elem) => {
  arr.push({
    title: $(elem).text(),
    url: $(elem).attr('href')
  })
})
return arr
```